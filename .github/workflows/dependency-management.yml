# ðŸ§ª EXPERIMENTAL WORKFLOW - FOR TESTING PURPOSES
# Custom dependency management implementation
# For production use, consider these proven alternatives:
# - renovatebot/renovate (automated dependency updates)
# - dependabot (GitHub's built-in dependency updates)
# - snyk/actions (security-focused dependency management)

name: Automated Dependency Management

on:
  schedule:
    # Run weekly on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of dependency update'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - security-only
      dry_run:
        description: 'Perform a dry run without creating PRs'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  BRANCH_PREFIX: 'automated/dependency-update'

jobs:
  analyze-dependencies:
    name: Analyze Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      has_updates: ${{ steps.dep_analysis.outputs.has_updates }}
      security_count: ${{ steps.security_check.outputs.count }}
      outdated_count: ${{ steps.outdated_check.outputs.count }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        if [ -f package-lock.json ]; then
          npm ci
        fi
    
    - name: Security audit
      id: security_check
      run: |
        echo "Running security audit..."
        
        if [ -f package.json ]; then
          npm audit --json > audit-report.json 2>/dev/null || true
          
          # Count vulnerabilities by severity
          CRITICAL=$(jq '[.vulnerabilities | to_entries[] | select(.value.severity == "critical")] | length' audit-report.json 2>/dev/null || echo "0")
          HIGH=$(jq '[.vulnerabilities | to_entries[] | select(.value.severity == "high")] | length' audit-report.json 2>/dev/null || echo "0")
          MODERATE=$(jq '[.vulnerabilities | to_entries[] | select(.value.severity == "moderate")] | length' audit-report.json 2>/dev/null || echo "0")
          LOW=$(jq '[.vulnerabilities | to_entries[] | select(.value.severity == "low")] | length' audit-report.json 2>/dev/null || echo "0")
          
          TOTAL_VULNS=$((CRITICAL + HIGH + MODERATE + LOW))
          echo "count=$TOTAL_VULNS" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          
          echo "Found $TOTAL_VULNS vulnerabilities: $CRITICAL critical, $HIGH high, $MODERATE moderate, $LOW low"
          
          # Create security report
          cat > security-report.md << EOF
          # Security Audit Report
          
          **Date**: $(date -u +"%Y-%m-%d %H:%M UTC")
          **Total Vulnerabilities**: $TOTAL_VULNS
          
          | Severity | Count |
          |----------|-------|
          | Critical | $CRITICAL |
          | High     | $HIGH |
          | Moderate | $MODERATE |
          | Low      | $LOW |
          
          EOF
          
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "::warning::Found $CRITICAL critical and $HIGH high severity vulnerabilities"
          fi
        else
          echo "count=0" >> $GITHUB_OUTPUT
        fi
    
    - name: Check for outdated dependencies
      id: outdated_check
      run: |
        if [ -f package.json ]; then
          npm outdated --json > outdated-report.json 2>/dev/null || echo "{}" > outdated-report.json
          
          OUTDATED_COUNT=$(jq 'length' outdated-report.json 2>/dev/null || echo "0")
          echo "count=$OUTDATED_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$OUTDATED_COUNT" -gt 0 ]; then
            echo "Found $OUTDATED_COUNT outdated dependencies"
            jq -r 'to_entries[] | "- \(.key): \(.value.current) â†’ \(.value.latest)"' outdated-report.json > outdated-list.txt
          else
            echo "All dependencies are up to date"
          fi
        else
          echo "count=0" >> $GITHUB_OUTPUT
        fi
    
    - name: Analyze dependency health
      id: dep_analysis
      run: |
        HAS_UPDATES="false"
        
        if [ "${{ steps.security_check.outputs.count }}" -gt 0 ] || [ "${{ steps.outdated_check.outputs.count }}" -gt 0 ]; then
          HAS_UPDATES="true"
        fi
        
        echo "has_updates=$HAS_UPDATES" >> $GITHUB_OUTPUT
        echo "Updates available: $HAS_UPDATES"

  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: analyze-dependencies
    if: needs.analyze-dependencies.outputs.has_updates == 'true'
    strategy:
      matrix:
        update-type: [security, outdated]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Create update branch
      run: |
        BRANCH_NAME="${{ env.BRANCH_PREFIX }}-${{ matrix.update-type }}-$(date +%Y%m%d-%H%M%S)"
        git checkout -b "$BRANCH_NAME"
        echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
    
    - name: Update security vulnerabilities
      if: matrix.update-type == 'security' && needs.analyze-dependencies.outputs.security_count > 0
      run: |
        echo "Updating security vulnerabilities..."
        
        if [ -f package.json ]; then
          # Try to fix security vulnerabilities
          npm audit fix --force || npm audit fix
          
          # Check if package-lock.json was updated
          if git diff --name-only | grep -q "package-lock.json"; then
            echo "Security vulnerabilities updated"
          else
            echo "No security vulnerabilities could be automatically fixed"
          fi
        fi
    
    - name: Update outdated dependencies
      if: matrix.update-type == 'outdated' && github.event.inputs.update_type != 'security-only'
      run: |
        echo "Updating outdated dependencies..."
        
        if [ -f package.json ]; then
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'patch' }}"
          
          case $UPDATE_TYPE in
            patch)
              npm update --save
              ;;
            minor)
              npm update --save
              # Additional logic for minor updates
              ;;
            major)
              echo "Major updates require manual review"
              # List major updates available
              npm outdated --json | jq -r 'to_entries[] | select(.value.type == "major") | .key' > major-updates.txt || true
              ;;
          esac
        fi
    
    - name: Test after updates
      run: |
        if [ -f package.json ]; then
          # Install updated dependencies
          npm ci
          
          # Run basic tests if available
          if npm run test --silent 2>/dev/null; then
            echo "Tests passed after dependency updates"
          else
            echo "No tests found or tests failed"
          fi
          
          # Run security audit again
          npm audit --audit-level=moderate || echo "Security audit completed"
        fi
    
    - name: Commit and create PR
      if: github.event.inputs.dry_run != 'true'
      run: |
        # Check if there are changes to commit
        if git diff --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Stage changes
        git add package.json package-lock.json || true
        git add *.md || true
        
        # Create commit message
        COMMIT_MSG="Automated dependency update (${{ matrix.update-type }})"
        if [ "${{ matrix.update-type }}" == "security" ]; then
          COMMIT_MSG="$COMMIT_MSG - Fixed security vulnerabilities"
        else
          COMMIT_MSG="$COMMIT_MSG - Updated outdated packages"
        fi
        
        git commit -m "$COMMIT_MSG" || echo "No changes to commit"
        
        # Push branch
        git push origin "$BRANCH_NAME"
        
        # Create PR using GitHub CLI
        if command -v gh >/dev/null 2>&1; then
          gh pr create \
            --title "$COMMIT_MSG" \
            --body "Automated dependency update performed by GitHub Actions.\n\nPlease review the changes before merging." \
            --base main \
            --head "$BRANCH_NAME" || echo "PR creation failed"
        else
          echo "GitHub CLI not available, please create PR manually"
        fi

  cleanup-old-branches:
    name: Cleanup Old Branches
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: update-dependencies
    if: always()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Cleanup old dependency update branches
      run: |
        echo "Cleaning up old dependency update branches..."
        
        # Find branches older than 30 days with our prefix
        OLD_BRANCHES=$(git branch -r --format="%(refname:short)" | grep -E "origin/${{ env.BRANCH_PREFIX }}" || true)
        
        for branch in $OLD_BRANCHES; do
          # Remove 'origin/' prefix
          BRANCH_NAME=${branch#origin/}
          
          # Check if branch is older than 30 days
          BRANCH_DATE=$(git log -1 --format=%ct "$branch" 2>/dev/null || echo "0")
          CURRENT_DATE=$(date +%s)
          AGE_DAYS=$(( (CURRENT_DATE - BRANCH_DATE) / 86400 ))
          
          if [ "$AGE_DAYS" -gt 30 ]; then
            echo "Deleting old branch: $BRANCH_NAME (age: $AGE_DAYS days)"
            git push origin --delete "$BRANCH_NAME" || echo "Failed to delete $BRANCH_NAME"
          fi
        done
        
        echo "Branch cleanup completed"

  notify-results:
    name: Notify Results
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [analyze-dependencies, update-dependencies]
    if: always()
    
    steps:
    - name: Generate summary report
      run: |
        echo "## Dependency Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Analysis Date**: $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Security Vulnerabilities Found**: ${{ needs.analyze-dependencies.outputs.security_count }}" >> $GITHUB_STEP_SUMMARY
        echo "**Outdated Dependencies**: ${{ needs.analyze-dependencies.outputs.outdated_count }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.analyze-dependencies.outputs.has_updates }}" == "true" ]; then
          echo "âœ… Dependency updates were processed" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ No dependency updates required" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- Review any created pull requests" >> $GITHUB_STEP_SUMMARY
        echo "- Test updated dependencies in staging environment" >> $GITHUB_STEP_SUMMARY
        echo "- Monitor application performance after updates" >> $GITHUB_STEP_SUMMARY